name: "On Push To Main"
run-name: "On Push To Main: ${{ github.event.head_commit.message }}"
on:
  push:
    branches: [ "main" ]

jobs:
  github-context:
    runs-on: ubuntu-latest
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: |
          echo "$GITHUB_CONTEXT"
  test:
    uses: ./.github/workflows/test.yml
  read-version-and-tag-exists:
    runs-on: ubuntu-latest
    needs:
      - test
    steps:
      - uses: actions/checkout@v4  
      - id: read_version
        run: |
          version=$(cat version)
          echo version=$version >> $GITHUB_OUTPUT'
          echo tag_exists=$(git tag | grep -qE ^$version$ && echo "true" || echo
    outputs:
      version: ${{ steps.read_version.outputs.version }}
      tag_exists: ${{ steps.read_version.outputs.tag_exists }}
  tag-and-release:
    permissions:
      contents: write
    needs:
      - read-version-and-tag-exists
    if: needs.read-version-and-tag-exists.outputs.tag_exists == 'false'
    uses: ./.github/workflows/tag-and-release.yml
    with:
      tag: ${{ needs.read-version-and-tag-exists.outputs.tag }}
  build-and-publish:
    needs: 
      - tag-and-release
    uses: ./.github/workflows/build-and-publish.yml
    with:
      tag: ${{ needs.tag-and-release.outputs.tag }}